name: Run tests and publish report
on: [pull_request, workflow_dispatch]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      # Install npm dependencies, cache them correctly
      # and run all Cypress tests
      # - name: Cypress run Component
      #   uses: cypress-io/github-action@v6
      #   with:
      #     component: true

      - name: Cypress run E2E
        uses: cypress-io/github-action@v6
        id: cypress

        # After publishing to gh-pages
      - name: Create test summary
        uses: test-summary/action@dist
        with:
          paths: cypress/reports/junit/*.xml
        if: always()
        id: testSummary

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./cypress/reports
          destination_dir: cypress/build/${{ github.run_number }}

      # - name: Comment PR with Allure Report link
      #   if: ${{ always() && github.event_name == 'pull_request' && steps.testSummary.outputs.total }}
      #   continue-on-error: true
      #   uses: thollander/actions-comment-pull-request@v2
      #   with:
      #     message: |
      #       ${{ steps.testSummary.outputs.passed }} / ${{ steps.testSummary.outputs.total }} tests passed
      #     comment_tag: allure_report
      #     mode: recreate

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2.16.1
        if: always()
        with:
          files: |
            cypress/reports/**/*.json
