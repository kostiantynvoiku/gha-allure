name: Second - Run tests and publish report
on: [pull_request, workflow_dispatch]

jobs:
  test:
    uses: bahmutov/cypress-workflows/.github/workflows/split.yml@v2
    with:
      nE2E: 3
      marge: true
      
  publish-report:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      checks: write
      contents: write
      pull-requests: write
      issues: read
    steps:
      - name: Checkout ðŸ›Ž
        uses: actions/checkout@v4

      # Assuming the report generation and deployment steps remain the same,
      # ensure they are updated to reflect any changes in outputs or paths
      # resulting from the use of the reusable workflow.

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./cypress/reports/html
          destination_dir: cypress/build/${{ github.run_number }}

      - name: Publish Report
        uses: turing85/publish-report@v2.0.1
        if: ${{ always() }}
        with:
          report-fail-on-error: true
          comment-enabled: false
          report-path: 'cypress/reports/html/index.json'
          report-reporter: mochawesome-json

      - name: ðŸ“¦ DEFINE VARS FOR SLACK
        if: always()
        run: |
          if [ "${{ job.status }}" == "failure" ]; then 
            echo "SLACK_COLOR=f71414" >> $GITHUB_ENV
          else 
            echo "SLACK_COLOR=28a745" >> $GITHUB_ENV

      - name: ðŸ“© POST MESSAGE TO SLACK
        if: always()
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }} 
        with:
          channel-id: 'C072KH2MPBJ'
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ env.SLACK_COLOR }}",
                  "blocks": [
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "ðŸ§ª Test run *<${{ env.RUN_URL }}|#${{ github.run_number }}>* has finished on `${{ github.event.repository.name }}` with the status: *${{ job.status }}*"
                      }
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "ðŸŸ¢ Passed: ${{ steps.report.outputs.tests-passed }} | ðŸ”´ Failed: ${{ steps.report.outputs.tests-failed }} | ðŸ”µ Skipped: ${{ steps.report.outputs.tests-skipped }}"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "MOCHAWESOME REPORT"
                          },
                          "url": "${{ env.REPORT_URL }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
env: 
  REPORT_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/cypress/build/${{ github.run_number }}
  RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}