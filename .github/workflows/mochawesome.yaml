name: Run tests and publish report
on: [pull_request, workflow_dispatch]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      checks: write
      contents: write
      pull-requests: write
      issues: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      # Install npm dependencies, cache them correctly
      # and run all Cypress tests
      # - name: Cypress run Component
      #   uses: cypress-io/github-action@v6
      #   with:
      #     component: true

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '20'

      - name: Install dependencies
        run: yarn install

      - name: Run end-to-end tests
        id: cypress
        run: yarn run cy:run:parallel

      - name: Generate Mochawesome Report
        if: always()
        run: yarn run generate-mochawesome-report

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./cypress/reports/html
          destination_dir: cypress/build/${{ github.run_number }}

      - name: Publish Report
        uses: turing85/publish-report@v2.0.1
        if: ${{ always() }}
        id: report
        with:
          report-fail-on-error: true # to fail when tests failed
          report-name: Tests
          report-path: 'cypress/reports/html/index.json'
          report-reporter: mochawesome-json
          comment-header: my-comment-header
          comment-message-success: |
              ## üß™ Cypress Results
              ### ü•≥  {0} failed
              | Passed | Failed | Skipped |
              |--------|--------|---------|
              | ‚úÖ {1} | ‚ùå {2} | ‚ö†Ô∏è {3}   |
              You can see the HTML report [here](${{ env.REPORT_URL }}).
          comment-message-failure: |
              ## üß™ Cypress Results
              ### üòî {0} failed
              | Passed | Failed | Skipped |
              |--------|--------|---------|
              | ‚úÖ {1} | ‚ùå {2} | ‚ö†Ô∏è {3}   |
              You can see the HTML report [here](${{ env.REPORT_URL }}).

      # - name: üì¶ DEFINE VARS FOR SLACK
      #   if: always()
      #   run: |
      #     if [ "${{ steps.e2e.outcome }}" == "failure" ]; then 
      #       echo "SLACK_COLOR=f71414" >> $GITHUB_ENV
      #     else 
      #       echo "SLACK_COLOR=28a745" >> $GITHUB_ENV
      #     fi
      
      # - name: Set Slack message color
      #   id: set-color
      #   run: |
      #     if [ "${{ job.status }}" == "success" ]; then
      #       echo "color=good" >> $GITHUB_ENV
      #     else
      #       echo "color=danger" >> $GITHUB_ENV
      #     fi
      
      - name: Post results to Slack
        if: always()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_CHANNEL: 'C072KH2MPBJ'
          MSG_MINIMAL: true
          SLACK_COLOR: ${{ job.status == 'success' && 'good' || 'danger' }}
          SLACK_TITLE: "Cypress Test Results"
          SLACK_MESSAGE: "The Cypress tests have completed. Here are the results:\n‚úÖ Passed: ${{ steps.report.outputs.tests-passed }}\n‚ùå Failed: ${{ steps.report.outputs.tests-failed }}\n‚ö†Ô∏è Skipped: ${{ steps.report.outputs.tests-skipped }}\nYou can see the detailed report [here](${{ env.REPORT_URL }})."
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}

env: 
  REPORT_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/cypress/build/${{ github.run_number }}
